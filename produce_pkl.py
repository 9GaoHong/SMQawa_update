import pickle
import numpy as np

##DY Data driven in DY(add dijet_mass < 400 ), work for MET full region(7 bins)
dd_2016_DY= {
"60-150": [34874.67748000214, 48610.69276461632, 20051.24246176201, 4463.823473439381, 873.9385287536777, 106.09562418823899, 31.061659437480117] ,
"150-300": [4931.921862178053, 7063.206081504877, 2986.1497053312883, 726.8721849597808, 137.50728599612725, 29.077064768713477, 11.957260011129058] ,
"300-800": [292.0576386970082, 433.14979208159804, 212.25229711161765, 63.22843151641453, 13.686630952095689, 2.5028826556950037, 2.646107496998445]
}

dd_2016APV_DY = {
"60-150": [41692.60554348361, 52382.08768905998, 18426.68615634485, 3688.831082650513, 536.3698601989494, 72.50242698158844, 16.291572256062913] ,
"150-300": [5770.728290685594, 7595.430762448846, 2913.8354254017577, 627.9893421380278, 104.18796521507213, 21.337099684140224, 10.289032587876296] ,
"300-800": [347.89391638138324, 490.99303175204653, 209.6782258260145, 54.113002649299496, 10.380108073644967, 1.7652373553033422, 0.5224252297528635]
}
# dd_2016APV_DY = {
# "60-150": [57546.0, 70489.0, 23990.0, 5001.0, 916.0, 247.0, 237.0] ,
# "150-300": [7905.0, 10049.0, 3950.0, 808.0, 99.0, 34.0, 36.0] ,
# "300-800": [499.0, 761.0, 297.0, 94.0, 7.0, 1.0, 7.0]
# }

dd_2017_DY = {
"60-150": [74933.1465291383, 114769.98719587518, 55948.17548076947, 14253.86131522109, 3979.8410286802036, 769.534781584661, 186.20069824193564] ,
"150-300": [10821.063967401966, 16995.6077530248, 8845.239592727798, 2660.780090164124, 635.1910424803547, 133.14024254305417, 50.491189511271706] ,
"300-800": [653.0090707804009, 1073.292991282311, 608.6923830840899, 216.91281198236985, 58.87359661448952, 16.390889543495803, 7.935314581614538]
}

dd_2018_DY = {
"60-150": [103913.26480713268, 157961.6645734838, 78604.92459599287, 22562.517024867815, 4706.200298776053, 622.4426665103229, 30.761048282237013],
"150-300": [15658.9934298558, 25097.73604905331, 13194.40928237031, 4045.3406929116663, 934.6132562817812, 175.59996971345112, 51.68263235188067] ,
"300-800": [938.1732293798996, 1561.3343224350458, 904.1973285845825, 316.42669617929124, 85.58704865678868, 16.122172383653165, 10.094938952700033]
}


##DY Data driven in SR, only work for MET [120,200,1200]

# dd_2016_SR = {
#     "60-150": [1, 1, 1, 1, 1, 1, 2.225666667, 0.148958333],
#     "150-300": [1, 1, 1, 1, 1, 1, 1.858083333, 0.037125],
#     "300-800": [1, 1, 1, 1, 1, 1, 0.285541667, 0.009166667]
# }

# dd_2016APV_SR = {
#     "60-150": [1, 1, 1, 1, 1, 1, 2.630333333, 0.176041667],
#     "150-300": [1, 1, 1, 1, 1, 1, 2.195916667, 0.043875],
#     "300-800": [1, 1, 1, 1, 1, 1, 0.337458333, 0.010833333]
# }

dd_2016_SR = {
    "60-150": [1, 1, 1, 1, 1, 1, 4.856, 0.325],
    "150-300": [1, 1, 1, 1, 1, 1, 4.054, 0.081],
    "300-800": [1, 1, 1, 1, 1, 1, 0.623, 0.0]
}
dd_2017_SR = {
    "60-150": [1, 1, 1, 1, 1, 1, 29.08881729, 0.280054486],
    "150-300": [1, 1, 1, 1, 1, 1, 10.95447044, 0.54004659],
    "300-800": [1, 1, 1, 1, 1, 1, 3.07814273, 0.167868917]
}

dd_2018_SR = {
    "60-150": [1, 1, 1, 1, 1, 1, 41.95692576, 0.40394304],
    "150-300": [1, 1, 1, 1, 1, 1, 15.8004328, 0.77894864],
    "300-800": [1, 1, 1, 1, 1, 1, 4.43983008, 0.2421296]
}


##DY MC in DY(add dijet_mass < 400 ), work for MET full region


mc_2018_DY = {
    "60-150": [124961.032977, 184883.674363, 93236.629663, 29083.02463, 6937.791433, 1353.652682, 271.582536],
    "150-300": [17396.356852, 26207.727915, 13865.934823, 4519.038009, 1135.404599, 253.679787, 59.897071999999994],
    "300-800": [1147.802651, 1844.555622, 1038.807008, 377.197931, 107.29013, 23.961881, 9.698467]
}

mc_2017_DY = {
    "60-150": [89590.804361, 134730.515631, 68502.892833, 22758.138984, 5341.345051, 1342.241525, 356.56308899999993],
    "150-300": [12532.185744, 19149.01171, 10277.033215, 33552.945039, 449.786456, 172.892089, 75.59628599999999],
    "300-800": [819.054765, 1322.226504, 750.928595, 262.469128, 77.688876, 21.945907, 5.786305999999999]
}

mc_2016_DY = {
    "60-150": [42576.507289, 49640.784728, 17114.469504, 3405.002252, 533.090055, 61.747467, 11.645950999999998],
    "150-300": [5808.801324, 7246.376317, 2692.222199, 588.337675, 103.093935, 16.998808, 2.6207239999999996],
    "300-800": [379.110727, 499.814878, 207.156984, 53.588416, 10.27326, 1.89586, 0.749707]
}

# mc_2016APV_DY = {
#     "60-150": [49181.781692, 57504.620381, 20044.924186, 4079.749873, 671.80054, 82.225194, 19.101793],
#     "150-300": [6788.077342, 8410.628766, 3085.646319, 681.154075, 122.606965, 10.45836, 4.838944],
#     "300-800": [424.568235, 558.291858, 236.830561, 64.824339, 13.512671, 2.591529, 0.8942959999999999]
# }
mc_2016APV_DY = {
    "60-150": [47253.875312, 55285.07591, 19270.042831, 3918.538608, 642.2445, 77.091541, 18.361047],
    "150-300": [5977.679275, 7437.034417, 2706.596226, 602.589961, 111.521608, 8.647481, 3.515794],
    "300-800": [423.23415, 557.092626, 236.112252, 64.727988, 13.488357, 2.558496, 0.8950889999999999]
}


##DY MC in SR, only work for MET [120,200,1200]
mc_2018_SR = {
    "60-150": [1, 1, 1, 1, 1, 1, 67.49655800000001, 1.248917],
    "150-300": [1, 1, 1, 1, 1, 1, 22.388162, 0.48909],
    "300-800": [1, 1, 1, 1, 1, 1, 3.70194, 0.17766200000000001] 
}

mc_2017_SR = {
    "60-150": [1, 1, 1, 1, 1, 1, 47.491327000000005,0.169905 ],
    "150-300": [1, 1, 1, 1, 1, 1, 17.986579, 0.014554],
    "300-800": [1, 1, 1, 1, 1, 1, 2.813811, 0.052483999999999996]
}

mc_2016_SR = {
    "60-150": [1, 1, 1, 1, 1, 1, 5.72452, 0.021964],
    "150-300": [1, 1, 1, 1, 1, 1, 3.820603, 0.016403],
    "300-800": [1, 1, 1, 1, 1, 1, 0.9938539999999999, 0.0]
}
# mc_2016_SR = {
#     "60-150": [1, 1, 1, 1, 1, 1, 2.901404, 0.007407],
#     "150-300": [1, 1, 1, 1, 1, 1, 1.13492, 0.016403],
#     "300-800": [1, 1, 1, 1, 1, 1, 0.29637600000000003, 0.0]
# }

# mc_2016APV_SR = {
#     "60-150": [1, 1, 1, 1, 1, 1, 2.8231159999999997, 0.014557]
#     "150-300": [1, 1, 1, 1, 1, 1, 2.685683,0.0],
#     "300-800": [1, 1, 1, 1, 1, 1, 0.6974779999999999, 0.0]
# }
 # 0.106900084




all_dd_DY = {
    "2016": dd_2016_DY,
    "2016APV": dd_2016APV_DY,
    "2017": dd_2017_DY,
    "2018": dd_2018_DY
}
all_mc_DY = {
    "2016": mc_2016_DY,
    "2016APV": mc_2016APV_DY,
    "2017": mc_2017_DY,
    "2018": mc_2018_DY
}
all_dd_SR = {
    "2016": dd_2016_SR,
    "2017": dd_2017_SR,
    "2018": dd_2018_SR
}
all_mc_SR = {
    "2016": mc_2016_SR,
    "2017": mc_2017_SR,
    "2018": mc_2018_SR
}
# eras=["2016APV"]
eras = ["2016","2016APV","2018","2017"]
for era in eras:
    result_dict = {}
    dd = all_dd_DY[era]
    mc = all_mc_DY[era]
    for key in dd:
        result_dict[key] = [
            val_dd / val_mc if val_mc != 0 else 1  
            for val_dd, val_mc in zip(dd[key], mc[key])
        ]
    ratio = {
        'met_pt_bin': np.array([-np.inf, 0., 20., 40., 60., 80., 100., 120., np.inf]),
        'dilep_pt_bin': np.array([-np.inf, 60., 150., 300., np.inf]),
        'ratio_mapping': np.array([
            [1.  , 1.  , 1.  , 1.  , 1.  , 1.  , 1.  , 1.   ],
            np.insert(np.array(result_dict["60-150"]),0,1.0), 
            np.insert(np.array(result_dict["150-300"]),0,1.0), 
            np.insert(np.array(result_dict["300-800"]),0,1.0) 
        ])
    }
    print(era,ratio)
    output_filepath = f'/afs/cern.ch/user/h/hgao/SMQawa/src/qawa/data/ddr/DDMC_Ratio_DY_{era}_hgao.pkl'
    with open(output_filepath, 'wb') as pkl_file:
        pickle.dump(ratio, pkl_file)

    print(f"Data has been saved to {output_filepath}")
eras = ["2016","2018","2017"]
for era in eras:
    result_dict = {}
    dd = all_dd_SR[era]
    mc = all_mc_SR[era]
    for key in dd:
        result_dict[key] = [
            val_dd / val_mc if val_mc != 0 else 1  
            for val_dd, val_mc in zip(dd[key], mc[key])
        ]
    ratio = {
        'met_pt_bin': np.array([-np.inf, 0., 20., 40., 60., 80., 100., 120., 200., np.inf]),
        'dilep_pt_bin': np.array([-np.inf, 60., 150., 300., np.inf]),
        'ratio_mapping': np.array([
            [1.  , 1.  , 1.  , 1.  , 1.  , 1.  , 1.  , 1.  , 1.  ],
            np.insert(np.array(result_dict["60-150"]),0,1.0), 
            np.insert(np.array(result_dict["150-300"]),0,1.0), 
            np.insert(np.array(result_dict["300-800"]),0,1.0) 
        ])
    }
    print(era,ratio)
    output_filepath = f'/afs/cern.ch/user/h/hgao/SMQawa/src/qawa/data/ddr/DDMC_Ratio_SR_{era}_hgao.pkl'
    with open(output_filepath, 'wb') as pkl_file:
        pickle.dump(ratio, pkl_file)

    print(f"Data has been saved to {output_filepath}")